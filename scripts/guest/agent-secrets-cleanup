#!/usr/bin/env bash
set -euo pipefail

umask 077

log() {
  printf "[agent-secrets-cleanup] %s\n" "$*" >&2
}

RUNNER_ENV="${AGENTLAB_RUNNER_ENV:-/etc/agentlab/agent-runner.env}"
if [[ -f "$RUNNER_ENV" ]]; then
  set -a
  # shellcheck disable=SC1090
  source "$RUNNER_ENV"
  set +a
fi

SECRETS_DIR="${AGENTLAB_SECRETS_DIR:-/run/agentlab/secrets}"
WORK_DIR_BASE="${AGENTLAB_WORK_DIR_BASE:-/tmp}"
REPO_DIR="${AGENTLAB_REPO_DIR:-}"
CLEANUP_SECRETS="${AGENTLAB_CLEANUP_SECRETS:-1}"
CLEANUP_REPO="${AGENTLAB_CLEANUP_REPO:-1}"

if [[ -z "$REPO_DIR" ]]; then
  if [[ -d /work && -w /work ]]; then
    REPO_DIR="/work/repo"
  else
    REPO_DIR="${WORK_DIR_BASE%/}/repo"
  fi
fi

clean_dir_contents() {
  local dir="$1"
  if [[ -z "$dir" || "$dir" == "/" ]]; then
    return 0
  fi
  if [[ ! -e "$dir" ]]; then
    return 0
  fi
  if [[ -d "$dir" ]]; then
    find "$dir" -mindepth 1 -exec rm -rf -- {} + >/dev/null 2>&1 || true
  else
    rm -f -- "$dir" >/dev/null 2>&1 || true
  fi
}

cleanup_secrets() {
  if [[ "$CLEANUP_SECRETS" == "0" ]]; then
    log "secrets cleanup disabled"
    return 0
  fi
  case "$SECRETS_DIR" in
    /run/*|/dev/shm/*)
      ;;
    *)
      log "skip secrets cleanup for unsafe path: $SECRETS_DIR"
      return 0
      ;;
  esac
  clean_dir_contents "$SECRETS_DIR"
}

cleanup_repo() {
  if [[ "$CLEANUP_REPO" == "0" ]]; then
    log "repo cleanup disabled"
    return 0
  fi
  if [[ -z "$REPO_DIR" || "$REPO_DIR" == "/" ]]; then
    return 0
  fi
  if [[ "$REPO_DIR" == /work/* ]]; then
    log "skip repo cleanup for workspace path: $REPO_DIR"
    return 0
  fi

  local base="${WORK_DIR_BASE%/}"
  if [[ -z "$base" || "$base" == "/" ]]; then
    log "skip repo cleanup for unsafe base: $WORK_DIR_BASE"
    return 0
  fi
  if [[ "$REPO_DIR" == "$base" ]]; then
    log "skip repo cleanup for base dir: $REPO_DIR"
    return 0
  fi
  case "$REPO_DIR/" in
    "$base"/*)
      ;;
    *)
      log "skip repo cleanup outside base: $REPO_DIR"
      return 0
      ;;
  esac

  rm -rf -- "$REPO_DIR" >/dev/null 2>&1 || true
}

cleanup_secrets
cleanup_repo

exit 0
