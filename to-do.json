{
  "schema_version": 1,
  "project": {
    "name": "agentlab",
    "root": "."
  },
  "source_files": [
    "AGENTLAB_DEV_SPECIFICATION.md",
    "PROXMOX_SPECS.md",
    "README.md"
  ],
  "tasks": [
    {
      "id": "T001",
      "title": "Create project skeleton, shared libs, and build pipeline for agentlabd/agentlab",
      "priority": 1,
      "status": "done",
      "details": "Set up repo layout, shared config/models/proxmox libs, and Makefile targets (build, lint, test) with CI-ready outputs.",
      "updated_at": "2026-01-29T22:19:07Z",
      "files": [
        ".github/workflows/ci.yml",
        ".gitignore",
        "Makefile",
        "cmd/agentlab/main.go",
        "cmd/agentlabd/main.go",
        "go.mod",
        "internal/buildinfo/buildinfo.go",
        "internal/config/config.go",
        "internal/db/db.go",
        "internal/models/models.go",
        "internal/proxmox/proxmox.go",
        "scripts/README.md",
        "to-do.json",
        "to-do.schema.json"
      ]
    },
    {
      "id": "T002",
      "title": "Implement host install script and systemd unit for agentlabd",
      "priority": 1,
      "status": "done",
      "details": "Install binaries, create /etc/agentlab + /var/lib/agentlab + /var/log/agentlab + /run/agentlab, enable agentlabd.service, and verify socket permissions.",
      "depends_on": [
        "T001"
      ],
      "updated_at": "2026-01-29T22:24:47Z",
      "files": [
        "scripts/README.md",
        "scripts/install_host.sh",
        "scripts/systemd/agentlabd.service",
        "to-do.json"
      ]
    },
    {
      "id": "T003",
      "title": "Create agent-only bridge (vmbr1) and enable IP forwarding",
      "priority": 1,
      "status": "done",
      "details": "Provision 10.77.0.0/16 with host IP 10.77.0.1 and persist sysctl forwarding.",
      "updated_at": "2026-01-29T22:28:01Z",
      "files": [
        "scripts/README.md",
        "scripts/net/setup_vmbr1.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T004",
      "title": "Configure nftables NAT and LAN/ULA egress blocks for agent subnet",
      "priority": 1,
      "status": "done",
      "details": "Masquerade 10.77.0.0/16 to vmbr0, allow established/related, and block RFC1918/link-local/ULA ranges with persistent rules.",
      "depends_on": [
        "T003"
      ],
      "updated_at": "2026-01-29T22:35:10Z",
      "files": [
        "scripts/README.md",
        "scripts/net/agent_nat.nft",
        "scripts/net/apply.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T005",
      "title": "Set up Tailscale subnet routing with asymmetric firewall policy",
      "priority": 1,
      "status": "done",
      "details": "Advertise 10.77.0.0/16 and allow tailnet→sandbox connections while blocking sandbox→tailnet new connections.",
      "depends_on": [
        "T003",
        "T004"
      ],
      "updated_at": "2026-01-29T22:43:25Z",
      "files": [
        "scripts/README.md",
        "scripts/net/agent_nat.nft",
        "scripts/net/apply.sh",
        "scripts/net/setup_tailscale_router.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T006",
      "title": "Create connectivity smoke test script for sandbox networking",
      "priority": 2,
      "status": "done",
      "details": "Validate Internet egress, LAN/tailnet blocks, and DNS resolution from a sandbox.",
      "depends_on": [
        "T004",
        "T005"
      ],
      "updated_at": "2026-01-30T02:07:45Z",
      "files": [
        "scripts/README.md",
        "scripts/net/smoke_test.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T007",
      "title": "Implement Proxmox backend interface with shell-based qm/pvesh backend",
      "priority": 1,
      "status": "done",
      "details": "Support clone, configure, start/stop/destroy, status query, and IP discovery hooks with unit tests.",
      "depends_on": [
        "T001"
      ],
      "updated_at": "2026-01-29T22:50:58Z",
      "files": [
        "internal/proxmox/proxmox.go",
        "internal/proxmox/shell_backend.go",
        "internal/proxmox/shell_backend_test.go",
        "to-do.json"
      ]
    },
    {
      "id": "T008",
      "title": "Manage cloud-init snippet lifecycle for sandboxes",
      "priority": 1,
      "status": "done",
      "details": "Generate minimal user-data snippets (hostname, SSH key, bootstrap token), store in snippets storage, and delete on teardown.",
      "depends_on": [
        "T007"
      ],
      "updated_at": "2026-01-29T22:55:14Z",
      "files": [
        "internal/proxmox/cloudinit_snippets.go",
        "internal/proxmox/cloudinit_snippets_test.go",
        "internal/config/config.go",
        "to-do.json"
      ]
    },
    {
      "id": "T009",
      "title": "Implement IP discovery via qemu-guest-agent with DHCP fallback",
      "priority": 1,
      "status": "done",
      "details": "Poll qga with backoff for vmbr1 address and fallback to DHCP lease parsing.",
      "depends_on": [
        "T007",
        "T018"
      ],
      "updated_at": "2026-01-29T23:03:14Z",
      "files": [
        "internal/proxmox/shell_backend.go",
        "internal/proxmox/shell_backend_test.go",
        "to-do.json"
      ]
    },
    {
      "id": "T010",
      "title": "Build agentlabd core service and config/profile loader",
      "priority": 1,
      "status": "done",
      "details": "Load /etc/agentlab/config.yaml and /etc/agentlab/profiles/*.yaml; bind Unix socket and guest bootstrap listener.",
      "depends_on": [
        "T001"
      ],
      "updated_at": "2026-01-29T23:09:02Z",
      "files": [
        "cmd/agentlabd/main.go",
        "go.mod",
        "go.sum",
        "internal/config/config.go",
        "internal/daemon/daemon.go",
        "internal/daemon/profiles.go",
        "to-do.json"
      ]
    },
    {
      "id": "T011",
      "title": "Implement SQLite schema and migrations for core tables",
      "priority": 1,
      "status": "done",
      "details": "Create sandboxes, jobs, profiles, workspaces, bootstrap_tokens, and events tables with migration runner.",
      "depends_on": [
        "T010"
      ],
      "updated_at": "2026-01-29T23:18:12Z",
      "files": [
        "go.mod",
        "go.sum",
        "internal/daemon/daemon.go",
        "internal/db/README.md",
        "internal/db/db.go",
        "internal/db/migrations.go",
        "to-do.json"
      ]
    },
    {
      "id": "T012",
      "title": "Build sandbox state machine and lease/TTL engine",
      "priority": 1,
      "status": "done",
      "details": "Persist deterministic transitions and background GC for expired sandboxes, including keepalive renewals.",
      "depends_on": [
        "T011",
        "T007"
      ],
      "updated_at": "2026-01-29T23:25:38Z",
      "files": [
        "internal/daemon/daemon.go",
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/sandbox_manager_test.go",
        "internal/db/sandboxes.go",
        "to-do.json"
      ]
    },
    {
      "id": "T013",
      "title": "Implement local control API over Unix socket",
      "priority": 1,
      "status": "done",
      "details": "Expose job/sandbox CRUD endpoints, lease renewals, and document in docs/api.md with versioned request/response types.",
      "depends_on": [
        "T010",
        "T011",
        "T012"
      ],
      "updated_at": "2026-01-29T23:34:52Z",
      "files": [
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "internal/daemon/sandbox_manager.go",
        "internal/db/jobs.go",
        "internal/db/migrations.go",
        "internal/db/sandboxes.go",
        "internal/models/models.go",
        "to-do.json"
      ]
    },
    {
      "id": "T014",
      "title": "Implement job orchestration flow (create → run → report → destroy)",
      "priority": 1,
      "status": "done",
      "details": "Create sandbox with bootstrap token, wait for runner updates, persist results/artifacts metadata, and destroy if ephemeral.",
      "depends_on": [
        "T013",
        "T017",
        "T020"
      ],
      "updated_at": "2026-01-29T23:55:54Z",
      "files": [
        "internal/config/config.go",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/runner_api.go",
        "internal/daemon/sandbox_alloc.go",
        "internal/db/bootstrap_tokens.go",
        "internal/db/jobs.go",
        "internal/db/sandboxes.go",
        "internal/models/models.go",
        "to-do.json"
      ]
    },
    {
      "id": "T015",
      "title": "Implement secrets-at-rest bundle format with encryption",
      "priority": 1,
      "status": "done",
      "details": "Support age/sops-encrypted bundles for git/LLM credentials and artifact tokens with rotation docs.",
      "depends_on": [
        "T010"
      ],
      "updated_at": "2026-01-30T00:04:49Z",
      "files": [
        "internal/secrets/bundle.go",
        "internal/secrets/bundle_test.go",
        "internal/config/config.go",
        "scripts/install_host.sh",
        "docs/secrets.md",
        "go.mod",
        "go.sum"
      ]
    },
    {
      "id": "T016",
      "title": "Implement one-time bootstrap token issuance and validation",
      "priority": 1,
      "status": "done",
      "details": "Mint short-lived tokens, store hash+expiry, and mark consumed on first successful fetch.",
      "depends_on": [
        "T011"
      ],
      "updated_at": "2026-01-30T00:09:47Z",
      "files": [
        "internal/db/bootstrap_tokens.go",
        "internal/db/bootstrap_tokens_test.go",
        "internal/daemon/job_orchestrator.go"
      ]
    },
    {
      "id": "T017",
      "title": "Build guest bootstrap API (/v1/bootstrap/fetch) bound to vmbr1",
      "priority": 1,
      "status": "done",
      "details": "Return minimal secrets/job payloads, authenticate by token+vmid, and enforce agent-subnet-only access.",
      "depends_on": [
        "T016",
        "T010"
      ],
      "updated_at": "2026-01-30T00:25:12Z",
      "files": [
        "internal/daemon/api_types.go",
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/daemon/daemon.go",
        "internal/db/jobs.go",
        "to-do.json"
      ]
    },
    {
      "id": "T018",
      "title": "Create Ubuntu template build script with cloud-init + qemu-guest-agent",
      "priority": 1,
      "status": "done",
      "details": "Download cloud image, create VM, enable qga, install base packages, and convert to template.",
      "updated_at": "2026-01-30T00:30:45Z",
      "files": [
        "scripts/README.md",
        "scripts/create_template.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T019",
      "title": "Package agent CLIs into the template with a dispatcher wrapper",
      "priority": 1,
      "status": "done",
      "details": "Install and pin Claude Code CLI, OpenAI Codex CLI, and OpenCode CLI; provide /usr/local/bin/agentlab-agent.",
      "depends_on": [
        "T018"
      ],
      "updated_at": "2026-01-30T00:43:16Z",
      "files": [
        "scripts/README.md",
        "scripts/create_template.sh",
        "scripts/guest/agentlab-agent",
        "to-do.json"
      ]
    },
    {
      "id": "T020",
      "title": "Implement agent-runner service for guest bootstrap and execution",
      "priority": 1,
      "status": "done",
      "details": "Fetch bootstrap payload, store secrets in tmpfs, clone repo, run agent loop, stream logs/status, and upload artifacts.",
      "depends_on": [
        "T017",
        "T019"
      ],
      "updated_at": "2026-01-30T00:54:31Z",
      "files": [
        "internal/proxmox/cloudinit_snippets.go",
        "internal/proxmox/cloudinit_snippets_test.go",
        "scripts/README.md",
        "scripts/create_template.sh",
        "scripts/guest/agent-runner",
        "scripts/guest/agent-runner.env",
        "scripts/guest/agent-runner.service",
        "to-do.json"
      ]
    },
    {
      "id": "T021",
      "title": "Add secrets cleanup on guest stop",
      "priority": 2,
      "status": "done",
      "details": "Wipe /run/secrets and temporary repo directories via ExecStopPost or dedicated cleanup unit.",
      "depends_on": [
        "T020"
      ],
      "updated_at": "2026-01-30T02:12:11Z",
      "files": [
        "scripts/README.md",
        "scripts/create_template.sh",
        "scripts/guest/agent-runner.env",
        "scripts/guest/agent-runner.service",
        "scripts/guest/agent-secrets-cleanup",
        "to-do.json"
      ]
    },
    {
      "id": "T022",
      "title": "Implement agentlab CLI commands for jobs and sandbox management",
      "priority": 1,
      "status": "done",
      "details": "Provide job run, sandbox new/list/show/destroy, lease renew, and logs --follow with --json output.",
      "depends_on": [
        "T013"
      ],
      "updated_at": "2026-01-30T01:07:51Z",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/db/events.go",
        "to-do.json"
      ]
    },
    {
      "id": "T023",
      "title": "Implement CLI SSH helper with Tailscale-aware messaging",
      "priority": 2,
      "status": "done",
      "details": "Resolve IP, print/exec ssh command, and warn when tailnet route is not reachable.",
      "depends_on": [
        "T009",
        "T005"
      ],
      "updated_at": "2026-01-30T02:23:27Z",
      "files": [
        "cmd/agentlab/main.go",
        "cmd/agentlab/ssh.go",
        "to-do.json"
      ]
    },
    {
      "id": "T024",
      "title": "Implement workspace volume management on local-zfs",
      "priority": 2,
      "status": "done",
      "details": "Create/attach/detach ZFS volumes, track attachment in DB, and prevent multi-attach.",
      "depends_on": [
        "T011",
        "T007"
      ],
      "updated_at": "2026-01-30T02:43:18Z",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/workspace_manager.go",
        "internal/db/sandboxes.go",
        "internal/db/workspaces.go",
        "internal/proxmox/proxmox.go",
        "internal/proxmox/shell_backend.go",
        "to-do.json"
      ]
    },
    {
      "id": "T025",
      "title": "Implement guest auto-mount for /work",
      "priority": 2,
      "status": "done",
      "details": "Detect workspace disk by label/UUID, format on first attach, and mount via systemd.",
      "depends_on": [
        "T024",
        "T018"
      ],
      "updated_at": "2026-01-30T02:54:56Z",
      "files": [
        "scripts/README.md",
        "scripts/create_template.sh",
        "scripts/guest/agent-runner.service",
        "scripts/guest/agentlab-workspace-setup",
        "scripts/guest/agentlab-workspace-setup.service",
        "scripts/guest/work.mount",
        "to-do.json"
      ]
    },
    {
      "id": "T026",
      "title": "Implement workspace rebind workflow",
      "priority": 2,
      "status": "done",
      "details": "Create new sandbox, attach workspace, and safely detach/destroy old sandbox as requested.",
      "depends_on": [
        "T024",
        "T025",
        "T012"
      ],
      "updated_at": "2026-01-30T03:14:51Z",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/workspace_rebind.go",
        "to-do.json"
      ]
    },
    {
      "id": "T027",
      "title": "Implement embedded artifact upload service in agentlabd",
      "priority": 1,
      "status": "done",
      "details": "Expose 10.77.0.1:8846 upload endpoint with scoped tokens, size limits, path sanitization, and DB metadata.",
      "depends_on": [
        "T010",
        "T017"
      ],
      "updated_at": "2026-01-30T01:24:43Z",
      "files": [
        "docs/secrets.md",
        "internal/config/config.go",
        "internal/daemon/api_types.go",
        "internal/daemon/artifact_api.go",
        "internal/daemon/artifact_api_test.go",
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/daemon/daemon.go",
        "internal/db/artifact_tokens.go",
        "internal/db/artifacts.go",
        "internal/db/migrations.go",
        "to-do.json"
      ]
    },
    {
      "id": "T028",
      "title": "Implement CLI artifact listing and download",
      "priority": 2,
      "status": "done",
      "details": "Provide job artifacts list and download commands, including latest bundle shortcut.",
      "depends_on": [
        "T027",
        "T022"
      ],
      "updated_at": "2026-01-30T03:28:15Z",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "to-do.json"
      ]
    },
    {
      "id": "T029",
      "title": "Implement artifact retention and garbage collection",
      "priority": 2,
      "status": "done",
      "details": "Apply per-profile TTLs, delete expired artifacts, and report deletions safely.",
      "depends_on": [
        "T027",
        "T012"
      ],
      "updated_at": "2026-01-30T03:37:18Z",
      "files": [
        "internal/daemon/artifact_api_test.go",
        "internal/daemon/artifact_gc.go",
        "internal/daemon/artifact_gc_test.go",
        "internal/daemon/daemon.go",
        "internal/db/artifacts.go",
        "to-do.json"
      ]
    },
    {
      "id": "T030",
      "title": "Ship agentlab Skills file for Claude Code CLI",
      "priority": 1,
      "status": "done",
      "details": "Create skills/agentlab/SKILL.md mapping high-level commands to agentlab CLI with guardrails.",
      "depends_on": [
        "T022"
      ],
      "updated_at": "2026-01-30T01:30:10Z",
      "files": [
        "skills/agentlab/SKILL.md",
        "to-do.json"
      ]
    },
    {
      "id": "T031",
      "title": "Package Skills with Claude Code configuration",
      "priority": 2,
      "status": "done",
      "details": "Document placement and ensure install_host or template build makes Skills discoverable.",
      "depends_on": [
        "T030",
        "T019"
      ],
      "updated_at": "2026-01-30T03:44:05Z",
      "files": [
        "AGENTLAB_DEV_SPECIFICATION.md",
        "scripts/README.md",
        "scripts/install_host.sh",
        "skills/agentlab/SKILL.md",
        "to-do.json"
      ]
    },
    {
      "id": "T032",
      "title": "Enforce no-host-mount policy in provisioning",
      "priority": 1,
      "status": "done",
      "details": "Add guardrails to refuse profiles requesting host bind mounts and document rationale.",
      "depends_on": [
        "T007"
      ],
      "updated_at": "2026-01-30T01:37:45Z",
      "files": [
        "internal/daemon/profile_validation.go",
        "internal/daemon/api.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/profile_validation_test.go",
        "internal/daemon/job_orchestrator_test.go",
        "PROXMOX_SPECS.md"
      ]
    },
    {
      "id": "T033",
      "title": "Implement secret redaction and log safety",
      "priority": 1,
      "status": "done",
      "details": "Scrub bootstrap tokens and sensitive env keys from logs with automated tests.",
      "depends_on": [
        "T015",
        "T017",
        "T020"
      ],
      "updated_at": "2026-01-30T01:50:34Z",
      "files": [
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/redaction.go",
        "internal/daemon/redaction_test.go",
        "scripts/guest/agent-runner",
        "to-do.json"
      ]
    },
    {
      "id": "T034",
      "title": "Harden agentlabd systemd service",
      "priority": 2,
      "status": "done",
      "details": "Apply ProtectSystem, PrivateTmp, NoNewPrivileges, and capability restrictions while keeping provisioning functional.",
      "depends_on": [
        "T002"
      ],
      "updated_at": "2026-01-30T03:46:56Z",
      "files": [
        "scripts/systemd/agentlabd.service",
        "to-do.json"
      ]
    },
    {
      "id": "T035",
      "title": "Evaluate optional inner sandboxing for agent process (bubblewrap)",
      "priority": 3,
      "status": "done",
      "details": "Prototype bubblewrap execution and document tradeoffs behind a profile flag.",
      "depends_on": [
        "T020"
      ],
      "updated_at": "2026-01-30T04:25:49Z",
      "files": [
        "PROXMOX_SPECS.md",
        "docs/runbook.md",
        "internal/daemon/api_types.go",
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/daemon/profile_inner_sandbox.go",
        "internal/daemon/profile_validation.go",
        "scripts/create_template.sh",
        "scripts/guest/agent-runner",
        "scripts/guest/agent-runner.env",
        "scripts/profiles/defaults.yaml",
        "to-do.json"
      ]
    },
    {
      "id": "T036",
      "title": "Implement event stream storage and per-job log surfaces",
      "priority": 2,
      "status": "done",
      "details": "Persist events in DB and surface recent events in job show responses.",
      "depends_on": [
        "T011",
        "T020"
      ],
      "updated_at": "2026-01-30T03:54:25Z",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/db/events.go",
        "to-do.json"
      ]
    },
    {
      "id": "T037",
      "title": "Write operator runbook documentation",
      "priority": 2,
      "status": "done",
      "details": "Cover template build, secrets rotation, debugging stuck sandboxes, daemon recovery, and Tailscale routing.",
      "depends_on": [
        "T003",
        "T005",
        "T018",
        "T002"
      ],
      "updated_at": "2026-01-30T03:57:59Z",
      "files": [
        "docs/runbook.md",
        "to-do.json"
      ]
    },
    {
      "id": "T038",
      "title": "Add optional Prometheus metrics endpoint",
      "priority": 3,
      "status": "done",
      "details": "Expose /metrics behind localhost-only flag with sandbox/job counters and timing distributions.",
      "depends_on": [
        "T010"
      ],
      "updated_at": "2026-01-30T04:35:55Z",
      "files": [
        "docs/runbook.md",
        "go.mod",
        "go.sum",
        "internal/config/config.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/metrics.go",
        "internal/daemon/sandbox_manager.go",
        "to-do.json"
      ]
    },
    {
      "id": "T039",
      "title": "Create end-to-end golden path integration test",
      "priority": 1,
      "status": "done",
      "details": "Automate sandbox create → run trivial repo task → upload artifact → teardown validation.",
      "depends_on": [
        "T002",
        "T004",
        "T014",
        "T020"
      ],
      "updated_at": "2026-01-30T01:59:57Z",
      "files": [
        "scripts/README.md",
        "scripts/tests/golden_path.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T040",
      "title": "Add network isolation regression tests",
      "priority": 2,
      "status": "done",
      "details": "Verify LAN/tailnet blocks and Internet egress from sandbox with repeatable checks.",
      "depends_on": [
        "T004",
        "T005"
      ],
      "updated_at": "2026-01-30T04:04:23Z",
      "files": [
        "scripts/README.md",
        "scripts/tests/network_isolation.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T041",
      "title": "Ship default profile YAMLs for yolo-ephemeral, yolo-workspace, and interactive-dev",
      "priority": 2,
      "status": "done",
      "details": "Provide baseline resource/network/secrets bundle configs in scripts/profiles/defaults.yaml compatible with agentlabd loader.",
      "depends_on": [
        "T010"
      ],
      "updated_at": "2026-01-30T04:09:50Z",
      "files": [
        "scripts/README.md",
        "scripts/profiles/defaults.yaml",
        "to-do.json"
      ]
    },
    {
      "id": "T042",
      "title": "Require explicit agent subnet/controller URLs when bootstrap/artifact listeners bind to wildcard",
      "priority": 1,
      "status": "done",
      "details": "bootstrap_listen/artifact_listen allow 0.0.0.0 or :port today, which yields invalid controller/artifact URLs and disables subnet restriction. Add validation or explicit config (agent_subnet/controller_url/artifact_upload_url), enforce remoteAllowed using the configured subnet, and cover with tests.",
      "updated_at": "2026-01-30T04:59:30Z",
      "files": [
        "internal/config/config.go",
        "internal/config/config_test.go",
        "internal/daemon/artifact_api.go",
        "internal/daemon/artifact_api_test.go",
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/daemon/daemon.go",
        "internal/daemon/testutil_test.go",
        "to-do.json"
      ]
    },
    {
      "id": "T043",
      "title": "Provision real VMs for sandbox new flow",
      "priority": 2,
      "status": "done",
      "details": "sandbox new currently creates only a DB record. Add a provisioning pipeline for non-job sandboxes (clone template, configure cloud-init/snippet, apply profile resources, start VM, IP discovery, state transitions) and align API/CLI/docs. Ensure destroy handles missing VMs gracefully.",
      "updated_at": "2026-01-30T05:11:06Z",
      "files": [
        "cmd/agentlab/commands.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/profile_resources.go",
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/sandbox_manager_test.go",
        "internal/daemon/workspace_rebind.go",
        "internal/proxmox/errors.go",
        "internal/proxmox/shell_backend.go",
        "to-do.json"
      ]
    },
    {
      "id": "T044",
      "title": "Run agentlab-agent inside repo directory in agent-runner",
      "priority": 1,
      "status": "done",
      "details": "When AGENT_COMMAND defaults to agentlab-agent, agent-runner does not cd into the repo, so agents start outside the checkout. Update scripts/guest/agent-runner to run agentlab-agent from $REPO_DIR and add a regression check (unit/integration) if feasible.",
      "files": [
        "scripts/README.md",
        "scripts/guest/agent-runner",
        "scripts/tests/agent_runner_repo_dir.sh",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T05:35:33Z"
    },
    {
      "id": "T045",
      "title": "Avoid consuming bootstrap tokens before response is ready",
      "priority": 1,
      "status": "done",
      "details": "BootstrapAPI consumes the one-time token before issuing artifact tokens and building the response; any subsequent error burns the token and prevents retries. Reorder/transactionalize token consumption or add a validate-then-consume flow, and add a test for retry safety.",
      "files": [
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/db/bootstrap_tokens.go",
        "internal/db/bootstrap_tokens_test.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T05:41:20Z"
    },
    {
      "id": "T046",
      "title": "Apply profile keepalive/TTL defaults when creating jobs/sandboxes",
      "priority": 2,
      "status": "done",
      "details": "Profiles define behavior.keepalive_default and behavior.ttl_minutes_default but the API currently ignores them when TTL/keepalive are omitted. Parse these defaults and apply them for job create, sandbox new, and workspace rebind (when ttl/keepalive not explicitly set). Add tests.",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/behavior_defaults_test.go",
        "internal/daemon/profile_behavior.go",
        "internal/daemon/workspace_rebind.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T05:58:01Z"
    },
    {
      "id": "T047",
      "title": "Restrict runner report endpoint to agent subnet or add authentication",
      "priority": 1,
      "status": "done",
      "details": "Runner reports are accepted from any remote address on the bootstrap listener. Enforce agent-subnet checks (like bootstrap/artifact) and/or require a shared token from the bootstrap payload; add coverage for rejection of non-agent sources.",
      "files": [
        "internal/daemon/runner_api.go",
        "internal/daemon/daemon.go",
        "internal/daemon/runner_api_test.go",
        "internal/daemon/bootstrap_api.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T06:11:53Z"
    },
    {
      "id": "T048",
      "title": "Move guest secrets directory under /run/agentlab to avoid clobbering /run/secrets",
      "priority": 2,
      "status": "done",
      "details": "Use an agentlab-specific secrets path (for example /run/agentlab/secrets) and update agent-runner, cleanup script, and systemd unit/runtime directories accordingly.",
      "files": [
        "AGENTLAB_DEV_SPECIFICATION.md",
        "PROXMOX_SPECS.md",
        "docs/runbook.md",
        "scripts/guest/agent-runner",
        "scripts/guest/agent-runner.service",
        "scripts/guest/agent-secrets-cleanup",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T06:16:41Z"
    },
    {
      "id": "T049",
      "title": "Add timeouts for CLI HTTP calls and provisioning steps",
      "priority": 3,
      "status": "done",
      "details": "The CLI client and job provisioning path can hang indefinitely when agentlabd or Proxmox commands stall. Add configurable timeouts (HTTP client, job orchestration/provisioning) and propagate context deadlines.",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "cmd/agentlab/ssh.go",
        "internal/config/config.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/workspace_rebind.go",
        "internal/proxmox/shell_backend.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T06:34:35Z"
    },
    {
      "id": "T050",
      "title": "Expand README with overview, prerequisites, and quickstart",
      "priority": 4,
      "status": "done",
      "details": "README currently contains only the title. Add a concise overview, setup prerequisites, and links to runbook/secrets/API docs.",
      "files": [
        "README.md",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T06:36:25Z"
    },
    {
      "id": "T051",
      "title": "Detach workspaces during lease GC cleanup",
      "priority": 2,
      "status": "done",
      "details": "Sandbox lease GC (SandboxManager.expireSandbox) destroys VMs without detaching workspace volumes or clearing workspace_id, leaving workspaces marked attached after TTL expiry. Detach via WorkspaceManager (tolerate missing VMs) and add coverage.",
      "files": [
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/sandbox_manager_test.go",
        "internal/daemon/workspace_manager.go",
        "internal/proxmox/shell_backend.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T06:53:42Z"
    },
    {
      "id": "T052",
      "title": "Ensure job failure cleanup succeeds after provisioning timeouts",
      "priority": 2,
      "status": "done",
      "details": "JobOrchestrator.Run/ProvisionSandbox uses a timeout context; when it expires, failJob and deferred cleanup run with a canceled context so job status updates and sandbox/snippet cleanup can be skipped. Use a fresh background context (with a short timeout) for failure updates/cleanup and add tests for timeout paths.",
      "files": [
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T07:07:19Z"
    },
    {
      "id": "T053",
      "title": "Propagate agent subnet to Proxmox IP discovery",
      "priority": 2,
      "status": "done",
      "details": "ShellBackend GuestIP selection ignores the configured agent subnet when multiple NICs are present. Wire agent_subnet (or derived subnet) into ShellBackend.AgentCIDR so IP discovery prefers vmbr1 addresses; add regression coverage for multi-IP selection.",
      "files": [
        "internal/daemon/daemon.go",
        "internal/daemon/daemon_test.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T07:26:36Z"
    },
    {
      "id": "T054",
      "title": "Use failure-timeout context for workspace rebind cleanup",
      "priority": 2,
      "status": "done",
      "details": "RebindWorkspace cleanup currently runs with the provision timeout context, so detach/reattach/destroy can be skipped after a timeout. Use a fresh background context with a short timeout for cleanup steps (matching job/provision cleanup) and add a timeout-path test.",
      "files": [
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/workspace_rebind.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T07:34:30Z"
    },
    {
      "id": "T055",
      "title": "Add curl timeouts for agent-runner bootstrap/report/upload",
      "priority": 3,
      "status": "done",
      "details": "agent-runner uses curl without connect/max timeouts for bootstrap fetch, status reports, and artifact uploads, which can hang indefinitely on network stalls. Add sane defaults (configurable via env) to prevent job hangs.",
      "files": [
        "scripts/guest/agent-runner",
        "scripts/guest/agent-runner.env",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T07:38:37Z"
    },
    {
      "id": "T056",
      "title": "Avoid agent-runner restart loops on jobless sandboxes",
      "priority": 2,
      "status": "done",
      "details": "agent-runner currently treats a 404 from /v1/bootstrap/fetch as a hard failure, which causes systemd restart loops for sandboxes created without jobs (sandbox new). Handle the no-job case explicitly (e.g., treat 404 as a clean exit, or gate runner start when no job is associated) and add a regression test or documented behavior.",
      "files": [
        "scripts/guest/agent-runner",
        "scripts/tests/agent_runner_no_job.sh",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T08:15:29Z"
    },
    {
      "id": "T057",
      "title": "Ensure create_template.sh creates cache dir when --image-file is used",
      "priority": 3,
      "status": "done",
      "details": "create_template.sh only creates CACHE_DIR when downloading the image; if --image-file is supplied and CACHE_DIR is missing, the WORK_IMAGE copy fails. Ensure the cache/work directory exists regardless of image source (and consider a small sanity check/test).",
      "files": [
        "scripts/create_template.sh",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T08:21:11Z"
    },
    {
      "id": "T058",
      "title": "Remove on-disk artifact if metadata insert fails",
      "priority": 3,
      "status": "done",
      "details": "Artifact uploads currently write the file before inserting the DB record; if CreateArtifact fails, the file is left behind and will never be GC’d. Delete the staged/renamed file on DB errors and add a regression test that forces a DB insert failure.",
      "tags": [
        "bug",
        "artifacts"
      ],
      "files": [
        "internal/daemon/artifact_api.go",
        "internal/daemon/artifact_api_test.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T08:37:45Z"
    },
    {
      "id": "T059",
      "title": "Implement sandbox start/stop lifecycle (API + CLI + state machine)",
      "priority": 1,
      "status": "done",
      "details": "AgentLab specs include start/stop endpoints and STOPPED sandboxes should be restartable. Implement start/stop operations end-to-end: state machine transitions, Proxmox backend calls, API endpoints, CLI commands, and tests.",
      "steps": [
        "Update sandbox state machine to allow STOPPED -> BOOTING/READY/RUNNING and READY/RUNNING -> STOPPED transitions.",
        "Implement SandboxManager Start/Stop helpers that call proxmox.Backend.Start/Stop and transition DB state with events.",
        "Add API endpoints: POST /v1/sandboxes/{vmid}/start and POST /v1/sandboxes/{vmid}/stop (with clear error codes for invalid states).",
        "Add CLI commands: agentlab sandbox start <vmid> and agentlab sandbox stop <vmid>.",
        "Add unit tests for state transitions, API handlers, and CLI happy paths using stub backends."
      ],
      "tags": [
        "roadmap-v0.2",
        "sandbox",
        "api",
        "cli"
      ],
      "files": [
        "cmd/agentlab/commands.go",
        "cmd/agentlab/commands_happy_path_test.go",
        "cmd/agentlab/main.go",
        "cmd/agentlab/main_test.go",
        "internal/daemon/api.go",
        "internal/daemon/api_sandbox_test.go",
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/sandbox_manager_test.go",
        "internal/models/models.go",
        "to-do.json"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T17:58:02Z"
    },
    {
      "id": "T060",
      "title": "Add profiles listing endpoint (/v1/profiles) and CLI command",
      "priority": 2,
      "status": "done",
      "details": "Expose loaded profile metadata to clients for UX improvements (modifiers, suggestions, status output). Implement GET /v1/profiles and a minimal CLI to list profile names and template VMIDs.",
      "steps": [
        "Define a minimal V1Profile type in internal/daemon/api_types.go (name, template_vmid, updated_at).",
        "Implement GET /v1/profiles in internal/daemon/api.go, sourcing data from the in-memory profiles map.",
        "Add CLI command: agentlab profile list (and --json output).",
        "Update docs/api.md and README.md to document /v1/profiles and CLI usage.",
        "Add tests for the endpoint and CLI output."
      ],
      "tags": [
        "roadmap-v0.2",
        "profiles",
        "api",
        "cli"
      ],
      "files": [
        "README.md",
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/commands_happy_path_test.go",
        "cmd/agentlab/main.go",
        "cmd/agentlab/main_test.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_profiles_test.go",
        "internal/daemon/api_types.go",
        "to-do.json"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T18:32:48Z"
    },
    {
      "id": "T061",
      "title": "Implement /v1/status endpoint for host + control-plane summary",
      "priority": 2,
      "status": "done",
      "details": "Add a single endpoint to summarize system health: sandbox counts by state, job counts by status, disk pressure signals, and recent failures. This powers an operator-friendly `agentlab status` UX and makes SLOs visible.",
      "steps": [
        "Add DB helpers to count sandboxes by state and jobs by status (and optionally recent event kinds).",
        "Define V1StatusResponse type in internal/daemon/api_types.go.",
        "Implement GET /v1/status in internal/daemon/api.go.",
        "Include at least: sandbox state counts, job status counts, artifacts dir size (or free space), and whether metrics listener is enabled.",
        "Add unit tests for response shape and basic counts."
      ],
      "tags": [
        "roadmap-v0.2",
        "observability",
        "api"
      ],
      "files": [
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "internal/daemon/api_status_test.go",
        "internal/db/sandboxes.go",
        "internal/db/jobs.go",
        "internal/db/events.go",
        "internal/db/sandboxes_test.go",
        "internal/db/jobs_test.go"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T18:40:44Z"
    },
    {
      "id": "T062",
      "title": "Add `agentlab status` CLI command (human + JSON output)",
      "priority": 2,
      "status": "done",
      "details": "Implement `agentlab status` to surface the most important operator signals quickly (running/stopped sandboxes, job state summary, warnings), with `--json` support for automation.",
      "steps": [
        "Add CLI command wiring in cmd/agentlab/main.go.",
        "Call GET /v1/status and print a compact summary table in human mode.",
        "Support --json output passthrough.",
        "Add CLI tests for both human and JSON output.",
        "Update README.md to include `agentlab status` in the quickstart and troubleshooting sections."
      ],
      "depends_on": [
        "T061"
      ],
      "tags": [
        "roadmap-v0.2",
        "observability",
        "cli"
      ],
      "files": [
        "README.md",
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/commands_happy_path_test.go",
        "cmd/agentlab/main.go",
        "to-do.json"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T18:47:14Z"
    },
    {
      "id": "T063",
      "title": "Instrument sandbox lifecycle SLO metrics (time-to-ready/ssh/start/stop/revert/destroy)",
      "priority": 2,
      "status": "done",
      "details": "Shift performance focus to perceived speed by instrumenting explicit SLOs: time-to-ready, time-to-ssh, time-to-job-start, time-to-revert, and time-to-destroy. Export as Prometheus histograms and surface key percentiles in docs/performance.md.",
      "steps": [
        "Extend internal/daemon/metrics.go with new histograms for: start duration, stop duration, revert duration, destroy duration, time-to-ssh (host TCP probe to port 22).",
        "Record observations in provisioning/start/stop/revert/destroy paths (ensure negative durations are ignored).",
        "Add events that include operation durations for easy debugging without Prometheus.",
        "Update docs/performance.md with example Prometheus queries for the new metrics."
      ],
      "depends_on": [
        "T059",
        "T061"
      ],
      "tags": [
        "roadmap-v0.2",
        "metrics",
        "observability"
      ],
      "files": [
        "docs/performance.md",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/metrics.go",
        "internal/daemon/sandbox_manager.go",
        "to-do.json"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T18:57:19Z"
    },
    {
      "id": "T064",
      "title": "Start-on-connect for `agentlab ssh` + one-command create-and-ssh flow",
      "priority": 2,
      "status": "done",
      "details": "Optimize for time-to-shell. `agentlab ssh <vmid>` should auto-start STOPPED sandboxes and optionally wait for SSH readiness. Add `agentlab sandbox new --and-ssh` to create + provision + attach in one command.",
      "steps": [
        "Update cmd/agentlab/ssh.go: if sandbox state is STOPPED, call /v1/sandboxes/{vmid}/start (unless --no-start).",
        "After starting, wait for sandbox IP (if missing) and optionally probe TCP port 22 before exec/printing the ssh command.",
        "Add `agentlab sandbox new --and-ssh` that provisions and then execs `agentlab ssh --exec`.",
        "Add regression tests for STOPPED sandboxes and `--no-start` behavior."
      ],
      "depends_on": [
        "T059"
      ],
      "tags": [
        "roadmap-v0.2",
        "cli",
        "ssh"
      ],
      "files": [
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "cmd/agentlab/main_test.go",
        "cmd/agentlab/ssh.go",
        "cmd/agentlab/ssh_test.go",
        "to-do.json"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T19:06:06Z"
    },
    {
      "id": "T065",
      "title": "Add Proxmox VM snapshot operations to backend (create/rollback/delete)",
      "priority": 1,
      "status": "done",
      "details": "Enable fast undo by adding snapshot primitives to the proxmox.Backend interface and implementing them for both APIBackend and ShellBackend. These will support sandbox revert-to-clean workflows.",
      "steps": [
        "Extend internal/proxmox/Backend interface with SnapshotCreate(vmid,name), SnapshotRollback(vmid,name), and SnapshotDelete(vmid,name) (or equivalent).",
        "Implement snapshot ops in internal/proxmox/api_backend.go using Proxmox /snapshot endpoints.",
        "Implement snapshot ops in internal/proxmox/shell_backend.go using qm snapshot/rollback/delsnapshot.",
        "Decide and document required VM state for rollback (prefer: ensure VM stopped before rollback; no vmstate snapshots).",
        "Add unit tests for the shell backend command construction and API backend request paths (mock HTTP)."
      ],
      "blockers": [],
      "tags": [
        "roadmap-v0.2",
        "proxmox",
        "undo",
        "backend"
      ],
      "files": [
        "internal/proxmox/proxmox.go",
        "internal/proxmox/api_backend.go",
        "internal/proxmox/shell_backend.go",
        "internal/proxmox/api_backend_test.go",
        "internal/proxmox/shell_backend_test.go",
        "internal/daemon/sandbox_manager_test.go",
        "internal/daemon/job_orchestrator_test.go"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T18:03:26Z"
    },
    {
      "id": "T066",
      "title": "Snapshot-on-provision: create canonical 'clean' snapshot for each sandbox",
      "priority": 1,
      "status": "done",
      "details": "Make undo instant by taking a canonical snapshot after successful sandbox provisioning (and workspace rebind). This snapshot becomes the target for `sandbox revert`.",
      "steps": [
        "After a sandbox reaches RUNNING/READY (post-IP), create snapshot name 'clean' (best-effort).",
        "Record an audit event on success/failure with snapshot name and error (do not block provisioning unless configured).",
        "Apply the same behavior in workspace rebind (new VM created for workspace).",
        "Add tests that snapshot creation is attempted exactly once per successful provision path (using stub backend)."
      ],
      "depends_on": [
        "T065"
      ],
      "tags": [
        "roadmap-v0.2",
        "undo",
        "snapshot"
      ],
      "files": [
        "internal/daemon/behavior_defaults_test.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/workspace_rebind.go",
        "to-do.json"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T18:11:46Z"
    },
    {
      "id": "T067",
      "title": "Implement sandbox revert endpoint + CLI (rollback to 'clean')",
      "priority": 1,
      "status": "done",
      "details": "Add `agentlab sandbox revert <vmid>` backed by POST /v1/sandboxes/{vmid}/revert. Default behavior: stop VM if running, rollback disk to snapshot 'clean', then optionally restart. Include safety checks for running jobs and emit audit events + metrics.",
      "steps": [
        "Add API endpoint POST /v1/sandboxes/{vmid}/revert with request options (e.g., force, restart).",
        "Implement revert operation: ensure VM is stopped (or stop it), perform snapshot rollback, then restart if requested.",
        "Handle missing snapshot 'clean' with an actionable error message (and guidance to recreate or snapshot).",
        "Add CLI command `agentlab sandbox revert <vmid>` with --force and --no-restart (or --restart) flags.",
        "Emit events: sandbox.revert.started/completed/failed (include duration and whether a restart occurred).",
        "Add tests for: stopped revert fast-path, running revert stop+rollback, and missing snapshot errors."
      ],
      "depends_on": [
        "T059",
        "T065",
        "T066"
      ],
      "tags": [
        "roadmap-v0.2",
        "undo",
        "api",
        "cli"
      ],
      "files": [
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/metrics.go",
        "internal/daemon/api_types.go",
        "internal/daemon/api.go",
        "internal/daemon/sandbox_manager_test.go",
        "internal/daemon/api_sandbox_test.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/api.go",
        "cmd/agentlab/main.go",
        "cmd/agentlab/main_test.go",
        "docs/api.md",
        "README.md"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T18:22:34Z"
    },
    {
      "id": "T068",
      "title": "Add sandbox last_used_at tracking + /touch endpoint for UX/auto-stop",
      "priority": 2,
      "status": "done",
      "details": "Support better lifecycle policies (idle stop) and UX by tracking when a sandbox was last used. Add a DB column + API field, plus a lightweight endpoint CLI can call to update last_used_at when users interact (ssh/logs/show).",
      "steps": [
        "Add DB migration to add sandboxes.last_used_at (nullable RFC3339).",
        "Extend models.Sandbox and V1SandboxResponse to include last_used_at.",
        "Add POST /v1/sandboxes/{vmid}/touch to set last_used_at=now (idempotent).",
        "Update CLI commands (ssh, logs, sandbox show) to call /touch best-effort.",
        "Update sandbox list/show output to surface last_used_at (human + JSON).",
        "Add unit tests for the new endpoint and DB behavior."
      ],
      "tags": [
        "roadmap-v0.2",
        "sandbox",
        "api",
        "db"
      ],
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/ssh.go",
        "cmd/agentlab/touch.go",
        "internal/daemon/api.go",
        "internal/daemon/api_sandbox_test.go",
        "internal/daemon/api_types.go",
        "internal/db/migrations.go",
        "internal/db/migrations_test.go",
        "internal/db/sandboxes.go",
        "internal/db/sandboxes_test.go",
        "internal/models/models.go",
        "internal/testing/testutil.go",
        "to-do.json"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T19:16:14Z"
    },
    {
      "id": "T069",
      "title": "Implement idle auto-stop (no SSH sessions + low CPU for N minutes)",
      "priority": 2,
      "status": "done",
      "details": "Default mental model: keep many sandboxes stopped cheaply, start on demand. Implement an idle auto-stop policy that stops RUNNING sandboxes when there are no active SSH sessions and CPU usage stays under a threshold for N minutes (separate from TTL lease GC).",
      "steps": [
        "Define profile behavior defaults for idle-stop (e.g., behavior.idle_stop_minutes_default) and a daemon-level enable/disable switch.",
        "Implement a periodic daemon loop to evaluate idle sandboxes and call Stop + state transition.",
        "Detect active SSH sessions via host conntrack/nftables (established flows to sandbox_ip:22) or another host-observable signal; make it testable via an interface.",
        "Fetch per-VM CPU usage from Proxmox status/current and apply a low-CPU threshold window.",
        "Emit sandbox.idle_stop events and add a metric for idle stops.",
        "Document defaults and caveats in docs/runbook.md and docs/faq.md."
      ],
      "depends_on": [
        "T059",
        "T068"
      ],
      "blockers": [],
      "tags": [
        "roadmap-v0.2",
        "sandbox",
        "cost-control",
        "daemon"
      ],
      "files": [
        "internal/daemon/daemon.go",
        "internal/daemon/idle_stop.go",
        "internal/daemon/idle_stop_test.go",
        "internal/daemon/metrics.go",
        "internal/daemon/profile_behavior.go",
        "internal/daemon/sandbox_manager_test.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/proxmox/proxmox.go",
        "internal/proxmox/api_backend.go",
        "internal/proxmox/shell_backend.go",
        "internal/proxmox/shell_backend_test.go",
        "internal/config/config.go",
        "internal/config/config_test.go",
        "docs/runbook.md",
        "docs/faq.md"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T19:30:34Z"
    },
    {
      "id": "T070",
      "title": "Add modifier syntax for sandbox creation (e.g., `sandbox new +small +secure`)",
      "priority": 3,
      "status": "done",
      "details": "Replace flag soup with safe, composable modifiers. Allow `agentlab sandbox new +small +secure` as sugar over named profiles (source of truth remains YAML profiles). Unknown modifiers should fail with a clear list of valid modifiers.",
      "steps": [
        "Extend CLI parsing for sandbox new to accept order-independent +mod tokens after flags.",
        "Resolve modifiers to a concrete profile name deterministically (e.g., sort modifiers and join with '-': secure-small).",
        "Validate existence via GET /v1/profiles and provide 'did you mean' suggestions.",
        "Update usage text and README examples.",
        "Add tests for modifier parsing, resolution, and error messages."
      ],
      "depends_on": [
        "T060"
      ],
      "tags": [
        "roadmap-v0.2",
        "cli",
        "profiles"
      ],
      "files": [
        "README.md",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "cmd/agentlab/modifiers.go",
        "cmd/agentlab/sandbox_modifiers_test.go",
        "to-do.json"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T19:39:14Z"
    },
    {
      "id": "T071",
      "title": "Plumb profile network.firewall_group into Proxmox VM config",
      "priority": 3,
      "status": "done",
      "details": "Profiles already specify network.firewall_group (e.g., agent_nat_default) but AgentLab does not apply it. Implement support so networking policy can be expressed as a simple profile knob and surfaced in sandbox show/list.",
      "steps": [
        "Extend profile parsing to read network.firewall (bool) and network.firewall_group (string).",
        "Define how firewall group is applied for QEMU NICs via Proxmox API/shell (research required) and implement it in both backends.",
        "Add validation: unknown/empty firewall_group should be rejected or defaulted consistently.",
        "Update docs/configuration.md to document firewall_group and its semantics.",
        "Add unit tests for config application (shell command args + API params)."
      ],
      "blockers": [],
      "tags": [
        "roadmap-v0.2",
        "network",
        "profiles",
        "proxmox"
      ],
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/commands_daemon_test.go",
        "docs/configuration.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/profile_resources.go",
        "internal/daemon/profile_validation.go",
        "internal/daemon/profile_validation_test.go",
        "internal/proxmox/api_backend.go",
        "internal/proxmox/api_backend_test.go",
        "internal/proxmox/proxmox.go",
        "internal/proxmox/shell_backend.go",
        "internal/proxmox/shell_backend_test.go",
        "to-do.json"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T19:53:27Z"
    },
    {
      "id": "T072",
      "title": "Add network.mode abstraction (off|nat|allowlist) and surface it everywhere",
      "priority": 4,
      "status": "todo",
      "details": "Make networking policy a simple mode that is obvious and consistently displayed. Add network.mode to profiles (off|nat|allowlist), map modes to firewall groups/rules, and show the effective mode in `sandbox list/show` and `agentlab status`.",
      "steps": [
        "Extend profile schema to accept network.mode (off|nat|allowlist) and validate values.",
        "Map network.mode to a firewall_group (or other implementation) without changing the underlying nftables architecture initially.",
        "Extend sandbox API response to include effective network mode (stored or computed).",
        "Update CLI list/show to print network mode prominently.",
        "Document the modes and defaults in README.md and docs/configuration.md."
      ],
      "depends_on": [
        "T071"
      ],
      "tags": [
        "network",
        "ux",
        "profiles"
      ],
      "files": [
        "internal/daemon/profile_resources.go",
        "internal/daemon/profile_validation.go",
        "internal/daemon/api_types.go",
        "cmd/agentlab/commands.go",
        "README.md",
        "docs/configuration.md"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T16:47:32Z"
    },
    {
      "id": "T073",
      "title": "Add exposures registry (DB + API) for explicit sandbox port exposure",
      "priority": 3,
      "status": "done",
      "details": "Make exposure explicit, host-owned, and auditable. Add a first-class exposure registry so sandboxes cannot self-expose services. This is the control-plane foundation for `sandbox expose`.",
      "steps": [
        "Add DB migration to create exposures table (name, vmid, port, target_ip, url, state, created_at, updated_at).",
        "Implement API endpoints: POST /v1/exposures, GET /v1/exposures, DELETE /v1/exposures/{name}.",
        "Emit audit events for create/delete exposure requests (before integration with tailscale).",
        "Add unit tests for DB CRUD and API handlers."
      ],
      "tags": [
        "roadmap-v0.2",
        "exposure",
        "api",
        "db"
      ],
      "files": [
        "internal/db/migrations.go",
        "internal/db/migrations_test.go",
        "internal/db/exposures.go",
        "internal/db/exposures_test.go",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/api_exposures_test.go",
        "to-do.json"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T20:01:10Z"
    },
    {
      "id": "T074",
      "title": "Implement Tailscale Serve integration for sandbox exposures (health-checked)",
      "priority": 3,
      "status": "todo",
      "details": "Wire the exposure registry to host-level Tailscale Serve (or a safe fallback) so `expose <vmid> :port` yields a stable tailnet-reachable URL/name. Include health checks and automatic cleanup on sandbox destroy.",
      "steps": [
        "Implement a tailscale integration module that can create/remove serve rules for a given exposure name -> sandbox_ip:port.",
        "On expose: resolve sandbox IP, install serve rule, run a TCP (and optional HTTP) health check, store resulting URL/state.",
        "On unexpose: remove serve rule and mark exposure deleted.",
        "Ensure exposures are cleaned up when the owning sandbox is destroyed (best-effort).",
        "Add integration tests that mock tailscale command execution."
      ],
      "depends_on": [
        "T073"
      ],
      "blockers": [
        "Decide whether to use `tailscale serve` CLI, Tailscale LocalAPI, or an SSH reverse proxy fallback (and document tradeoffs)."
      ],
      "tags": [
        "roadmap-v0.2",
        "exposure",
        "tailscale",
        "security"
      ],
      "files": [
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/api.go",
        "docs/runbook.md"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T16:47:32Z"
    },
    {
      "id": "T075",
      "title": "Add CLI commands for exposures (expose/exposed/unexpose) + docs",
      "priority": 3,
      "status": "todo",
      "details": "Expose should be a top-level verb for users. Add CLI commands to manage exposures and document the security model (host-owned, auditable).",
      "steps": [
        "Add CLI commands: agentlab sandbox expose <vmid> :<port>, agentlab sandbox exposed, agentlab sandbox unexpose <name>.",
        "Support --json output for all commands.",
        "Update docs/api.md and README.md with examples and expected output.",
        "Add CLI tests that validate request paths and response rendering."
      ],
      "depends_on": [
        "T073",
        "T074"
      ],
      "tags": [
        "roadmap-v0.2",
        "exposure",
        "cli",
        "docs"
      ],
      "files": [
        "cmd/agentlab/main.go",
        "cmd/agentlab/commands.go",
        "docs/api.md",
        "README.md"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T16:47:32Z"
    },
    {
      "id": "T076",
      "title": "Humane errors: fuzzy suggestions + next-step hints across CLI",
      "priority": 3,
      "status": "todo",
      "details": "Reduce tooling tax during fast iteration. Add fuzzy suggestions for VMIDs and profile names, and always print the next best command when failing (e.g., suggest `agentlab sandbox list`).",
      "steps": [
        "Implement a small suggestion helper (Levenshtein or prefix match) for profile names and common subcommands.",
        "On sandbox not found: suggest nearest VMIDs from sandbox list.",
        "On unknown profile/modifier: suggest closest profile names from /v1/profiles.",
        "Standardize error output formatting and ensure `--json` mode remains machine-readable.",
        "Add unit tests for suggestion ranking and output."
      ],
      "depends_on": [
        "T060"
      ],
      "tags": [
        "roadmap-v0.2",
        "ux",
        "cli"
      ],
      "files": [
        "cmd/agentlab/main.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/ssh.go"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T16:47:32Z"
    },
    {
      "id": "T077",
      "title": "Panic button: stop all sandboxes (API + CLI) with audit events",
      "priority": 3,
      "status": "todo",
      "details": "When an agent goes rogue, operators need one command. Add a stop-all endpoint and CLI flag that stops all running sandboxes quickly and records audit events.",
      "steps": [
        "Add API endpoint POST /v1/sandboxes/stop_all (best-effort stop each VM; return counts).",
        "Add CLI command/flag: agentlab sandbox stop --all (and optionally --force).",
        "Emit an audit event for the stop-all invocation and per-sandbox stop results.",
        "Add tests for the endpoint behavior on mixed sandbox states."
      ],
      "depends_on": [
        "T059"
      ],
      "tags": [
        "roadmap-v0.2",
        "safety",
        "api",
        "cli"
      ],
      "files": [
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/sandbox_manager.go",
        "cmd/agentlab/main.go",
        "cmd/agentlab/commands.go"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T16:47:32Z"
    },
    {
      "id": "T078",
      "title": "Spike: optional SSH gateway routing layer (ssh new@host, ssh sbx-<id>@host)",
      "priority": 5,
      "status": "todo",
      "details": "Explore an SSH-first UX layer similar to Sandboxed: route ssh usernames to create/connect actions (ssh new@host, ssh 1001@host). This is a bigger bet and should start as a design doc + prototype to validate feasibility with Proxmox + Tailscale routing.",
      "steps": [
        "Write a short design doc covering: auth model, username grammar, routing logic, attach mechanism, and audit logging.",
        "Prototype a minimal gateway that can authenticate keys and call the existing /v1 API over unix socket.",
        "Decide whether this replaces or complements tailscale subnet routing (threat model + firewall impact)."
      ],
      "tags": [
        "future",
        "ssh",
        "ux"
      ],
      "files": [
        "docs"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T16:47:32Z"
    },
    {
      "id": "T079",
      "title": "Add confirmation gates / --force semantics for destructive or security-weakening operations",
      "priority": 4,
      "status": "todo",
      "details": "Codify safe defaults: destructive or security-weakening actions should require explicit confirmation in interactive CLI usage and/or a `--force` flag. This includes revert-running, expose, stop-all, and network policy changes.",
      "steps": [
        "Define a consistent CLI confirmation UX (interactive prompt when TTY; require --force in non-interactive).",
        "Apply to: sandbox revert (when running), sandbox expose, sandbox stop --all, and any operation that enables broader networking.",
        "Ensure `--json` mode does not prompt and fails with an actionable error unless `--force` is supplied.",
        "Emit audit events that record when --force was used.",
        "Add tests for prompt gating logic and non-interactive behavior."
      ],
      "depends_on": [
        "T067",
        "T073",
        "T077"
      ],
      "tags": [
        "safety",
        "ux",
        "cli"
      ],
      "files": [
        "cmd/agentlab/main.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/ssh.go"
      ],
      "created_at": "2026-02-08T16:47:32Z",
      "updated_at": "2026-02-08T16:47:32Z"
    }
  ]
}
