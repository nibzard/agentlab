{
  "schema_version": 1,
  "project": {
    "name": "agentlab",
    "root": "."
  },
  "source_files": [
    "AGENTLAB_DEV_SPECIFICATION.md",
    "PROXMOX_SPECS.md",
    "README.md"
  ],
  "tasks": [
    {
      "id": "T001",
      "title": "Create project skeleton, shared libs, and build pipeline for agentlabd/agentlab",
      "priority": 1,
      "status": "done",
      "details": "Set up repo layout, shared config/models/proxmox libs, and Makefile targets (build, lint, test) with CI-ready outputs.",
      "updated_at": "2026-01-29T22:19:07Z",
      "files": [
        ".github/workflows/ci.yml",
        ".gitignore",
        "Makefile",
        "cmd/agentlab/main.go",
        "cmd/agentlabd/main.go",
        "go.mod",
        "internal/buildinfo/buildinfo.go",
        "internal/config/config.go",
        "internal/db/db.go",
        "internal/models/models.go",
        "internal/proxmox/proxmox.go",
        "scripts/README.md",
        "to-do.json",
        "to-do.schema.json"
      ]
    },
    {
      "id": "T002",
      "title": "Implement host install script and systemd unit for agentlabd",
      "priority": 1,
      "status": "done",
      "details": "Install binaries, create /etc/agentlab + /var/lib/agentlab + /var/log/agentlab + /run/agentlab, enable agentlabd.service, and verify socket permissions.",
      "depends_on": [
        "T001"
      ],
      "updated_at": "2026-01-29T22:24:47Z",
      "files": [
        "scripts/README.md",
        "scripts/install_host.sh",
        "scripts/systemd/agentlabd.service",
        "to-do.json"
      ]
    },
    {
      "id": "T003",
      "title": "Create agent-only bridge (vmbr1) and enable IP forwarding",
      "priority": 1,
      "status": "done",
      "details": "Provision 10.77.0.0/16 with host IP 10.77.0.1 and persist sysctl forwarding.",
      "updated_at": "2026-01-29T22:28:01Z",
      "files": [
        "scripts/README.md",
        "scripts/net/setup_vmbr1.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T004",
      "title": "Configure nftables NAT and LAN/ULA egress blocks for agent subnet",
      "priority": 1,
      "status": "done",
      "details": "Masquerade 10.77.0.0/16 to vmbr0, allow established/related, and block RFC1918/link-local/ULA ranges with persistent rules.",
      "depends_on": [
        "T003"
      ],
      "updated_at": "2026-01-29T22:35:10Z",
      "files": [
        "scripts/README.md",
        "scripts/net/agent_nat.nft",
        "scripts/net/apply.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T005",
      "title": "Set up Tailscale subnet routing with asymmetric firewall policy",
      "priority": 1,
      "status": "done",
      "details": "Advertise 10.77.0.0/16 and allow tailnet→sandbox connections while blocking sandbox→tailnet new connections.",
      "depends_on": [
        "T003",
        "T004"
      ],
      "updated_at": "2026-01-29T22:43:25Z",
      "files": [
        "scripts/README.md",
        "scripts/net/agent_nat.nft",
        "scripts/net/apply.sh",
        "scripts/net/setup_tailscale_router.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T006",
      "title": "Create connectivity smoke test script for sandbox networking",
      "priority": 2,
      "status": "done",
      "details": "Validate Internet egress, LAN/tailnet blocks, and DNS resolution from a sandbox.",
      "depends_on": [
        "T004",
        "T005"
      ],
      "updated_at": "2026-01-30T02:07:45Z",
      "files": [
        "scripts/README.md",
        "scripts/net/smoke_test.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T007",
      "title": "Implement Proxmox backend interface with shell-based qm/pvesh backend",
      "priority": 1,
      "status": "done",
      "details": "Support clone, configure, start/stop/destroy, status query, and IP discovery hooks with unit tests.",
      "depends_on": [
        "T001"
      ],
      "updated_at": "2026-01-29T22:50:58Z",
      "files": [
        "internal/proxmox/proxmox.go",
        "internal/proxmox/shell_backend.go",
        "internal/proxmox/shell_backend_test.go",
        "to-do.json"
      ]
    },
    {
      "id": "T008",
      "title": "Manage cloud-init snippet lifecycle for sandboxes",
      "priority": 1,
      "status": "done",
      "details": "Generate minimal user-data snippets (hostname, SSH key, bootstrap token), store in snippets storage, and delete on teardown.",
      "depends_on": [
        "T007"
      ],
      "updated_at": "2026-01-29T22:55:14Z",
      "files": [
        "internal/proxmox/cloudinit_snippets.go",
        "internal/proxmox/cloudinit_snippets_test.go",
        "internal/config/config.go",
        "to-do.json"
      ]
    },
    {
      "id": "T009",
      "title": "Implement IP discovery via qemu-guest-agent with DHCP fallback",
      "priority": 1,
      "status": "done",
      "details": "Poll qga with backoff for vmbr1 address and fallback to DHCP lease parsing.",
      "depends_on": [
        "T007",
        "T018"
      ],
      "updated_at": "2026-01-29T23:03:14Z",
      "files": [
        "internal/proxmox/shell_backend.go",
        "internal/proxmox/shell_backend_test.go",
        "to-do.json"
      ]
    },
    {
      "id": "T010",
      "title": "Build agentlabd core service and config/profile loader",
      "priority": 1,
      "status": "done",
      "details": "Load /etc/agentlab/config.yaml and /etc/agentlab/profiles/*.yaml; bind Unix socket and guest bootstrap listener.",
      "depends_on": [
        "T001"
      ],
      "updated_at": "2026-01-29T23:09:02Z",
      "files": [
        "cmd/agentlabd/main.go",
        "go.mod",
        "go.sum",
        "internal/config/config.go",
        "internal/daemon/daemon.go",
        "internal/daemon/profiles.go",
        "to-do.json"
      ]
    },
    {
      "id": "T011",
      "title": "Implement SQLite schema and migrations for core tables",
      "priority": 1,
      "status": "done",
      "details": "Create sandboxes, jobs, profiles, workspaces, bootstrap_tokens, and events tables with migration runner.",
      "depends_on": [
        "T010"
      ],
      "updated_at": "2026-01-29T23:18:12Z",
      "files": [
        "go.mod",
        "go.sum",
        "internal/daemon/daemon.go",
        "internal/db/README.md",
        "internal/db/db.go",
        "internal/db/migrations.go",
        "to-do.json"
      ]
    },
    {
      "id": "T012",
      "title": "Build sandbox state machine and lease/TTL engine",
      "priority": 1,
      "status": "done",
      "details": "Persist deterministic transitions and background GC for expired sandboxes, including keepalive renewals.",
      "depends_on": [
        "T011",
        "T007"
      ],
      "updated_at": "2026-01-29T23:25:38Z",
      "files": [
        "internal/daemon/daemon.go",
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/sandbox_manager_test.go",
        "internal/db/sandboxes.go",
        "to-do.json"
      ]
    },
    {
      "id": "T013",
      "title": "Implement local control API over Unix socket",
      "priority": 1,
      "status": "done",
      "details": "Expose job/sandbox CRUD endpoints, lease renewals, and document in docs/api.md with versioned request/response types.",
      "depends_on": [
        "T010",
        "T011",
        "T012"
      ],
      "updated_at": "2026-01-29T23:34:52Z",
      "files": [
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "internal/daemon/sandbox_manager.go",
        "internal/db/jobs.go",
        "internal/db/migrations.go",
        "internal/db/sandboxes.go",
        "internal/models/models.go",
        "to-do.json"
      ]
    },
    {
      "id": "T014",
      "title": "Implement job orchestration flow (create → run → report → destroy)",
      "priority": 1,
      "status": "done",
      "details": "Create sandbox with bootstrap token, wait for runner updates, persist results/artifacts metadata, and destroy if ephemeral.",
      "depends_on": [
        "T013",
        "T017",
        "T020"
      ],
      "updated_at": "2026-01-29T23:55:54Z",
      "files": [
        "internal/config/config.go",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/runner_api.go",
        "internal/daemon/sandbox_alloc.go",
        "internal/db/bootstrap_tokens.go",
        "internal/db/jobs.go",
        "internal/db/sandboxes.go",
        "internal/models/models.go",
        "to-do.json"
      ]
    },
    {
      "id": "T015",
      "title": "Implement secrets-at-rest bundle format with encryption",
      "priority": 1,
      "status": "done",
      "details": "Support age/sops-encrypted bundles for git/LLM credentials and artifact tokens with rotation docs.",
      "depends_on": [
        "T010"
      ],
      "updated_at": "2026-01-30T00:04:49Z",
      "files": [
        "internal/secrets/bundle.go",
        "internal/secrets/bundle_test.go",
        "internal/config/config.go",
        "scripts/install_host.sh",
        "docs/secrets.md",
        "go.mod",
        "go.sum"
      ]
    },
    {
      "id": "T016",
      "title": "Implement one-time bootstrap token issuance and validation",
      "priority": 1,
      "status": "done",
      "details": "Mint short-lived tokens, store hash+expiry, and mark consumed on first successful fetch.",
      "depends_on": [
        "T011"
      ],
      "updated_at": "2026-01-30T00:09:47Z",
      "files": [
        "internal/db/bootstrap_tokens.go",
        "internal/db/bootstrap_tokens_test.go",
        "internal/daemon/job_orchestrator.go"
      ]
    },
    {
      "id": "T017",
      "title": "Build guest bootstrap API (/v1/bootstrap/fetch) bound to vmbr1",
      "priority": 1,
      "status": "done",
      "details": "Return minimal secrets/job payloads, authenticate by token+vmid, and enforce agent-subnet-only access.",
      "depends_on": [
        "T016",
        "T010"
      ],
      "updated_at": "2026-01-30T00:25:12Z",
      "files": [
        "internal/daemon/api_types.go",
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/daemon/daemon.go",
        "internal/db/jobs.go",
        "to-do.json"
      ]
    },
    {
      "id": "T018",
      "title": "Create Ubuntu template build script with cloud-init + qemu-guest-agent",
      "priority": 1,
      "status": "done",
      "details": "Download cloud image, create VM, enable qga, install base packages, and convert to template.",
      "updated_at": "2026-01-30T00:30:45Z",
      "files": [
        "scripts/README.md",
        "scripts/create_template.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T019",
      "title": "Package agent CLIs into the template with a dispatcher wrapper",
      "priority": 1,
      "status": "done",
      "details": "Install and pin Claude Code CLI, OpenAI Codex CLI, and OpenCode CLI; provide /usr/local/bin/agentlab-agent.",
      "depends_on": [
        "T018"
      ],
      "updated_at": "2026-01-30T00:43:16Z",
      "files": [
        "scripts/README.md",
        "scripts/create_template.sh",
        "scripts/guest/agentlab-agent",
        "to-do.json"
      ]
    },
    {
      "id": "T020",
      "title": "Implement agent-runner service for guest bootstrap and execution",
      "priority": 1,
      "status": "done",
      "details": "Fetch bootstrap payload, store secrets in tmpfs, clone repo, run agent loop, stream logs/status, and upload artifacts.",
      "depends_on": [
        "T017",
        "T019"
      ],
      "updated_at": "2026-01-30T00:54:31Z",
      "files": [
        "internal/proxmox/cloudinit_snippets.go",
        "internal/proxmox/cloudinit_snippets_test.go",
        "scripts/README.md",
        "scripts/create_template.sh",
        "scripts/guest/agent-runner",
        "scripts/guest/agent-runner.env",
        "scripts/guest/agent-runner.service",
        "to-do.json"
      ]
    },
    {
      "id": "T021",
      "title": "Add secrets cleanup on guest stop",
      "priority": 2,
      "status": "done",
      "details": "Wipe /run/secrets and temporary repo directories via ExecStopPost or dedicated cleanup unit.",
      "depends_on": [
        "T020"
      ],
      "updated_at": "2026-01-30T02:12:11Z",
      "files": [
        "scripts/README.md",
        "scripts/create_template.sh",
        "scripts/guest/agent-runner.env",
        "scripts/guest/agent-runner.service",
        "scripts/guest/agent-secrets-cleanup",
        "to-do.json"
      ]
    },
    {
      "id": "T022",
      "title": "Implement agentlab CLI commands for jobs and sandbox management",
      "priority": 1,
      "status": "done",
      "details": "Provide job run, sandbox new/list/show/destroy, lease renew, and logs --follow with --json output.",
      "depends_on": [
        "T013"
      ],
      "updated_at": "2026-01-30T01:07:51Z",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/db/events.go",
        "to-do.json"
      ]
    },
    {
      "id": "T023",
      "title": "Implement CLI SSH helper with Tailscale-aware messaging",
      "priority": 2,
      "status": "done",
      "details": "Resolve IP, print/exec ssh command, and warn when tailnet route is not reachable.",
      "depends_on": [
        "T009",
        "T005"
      ],
      "updated_at": "2026-01-30T02:23:27Z",
      "files": [
        "cmd/agentlab/main.go",
        "cmd/agentlab/ssh.go",
        "to-do.json"
      ]
    },
    {
      "id": "T024",
      "title": "Implement workspace volume management on local-zfs",
      "priority": 2,
      "status": "done",
      "details": "Create/attach/detach ZFS volumes, track attachment in DB, and prevent multi-attach.",
      "depends_on": [
        "T011",
        "T007"
      ],
      "updated_at": "2026-01-30T02:43:18Z",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/workspace_manager.go",
        "internal/db/sandboxes.go",
        "internal/db/workspaces.go",
        "internal/proxmox/proxmox.go",
        "internal/proxmox/shell_backend.go",
        "to-do.json"
      ]
    },
    {
      "id": "T025",
      "title": "Implement guest auto-mount for /work",
      "priority": 2,
      "status": "done",
      "details": "Detect workspace disk by label/UUID, format on first attach, and mount via systemd.",
      "depends_on": [
        "T024",
        "T018"
      ],
      "updated_at": "2026-01-30T02:54:56Z",
      "files": [
        "scripts/README.md",
        "scripts/create_template.sh",
        "scripts/guest/agent-runner.service",
        "scripts/guest/agentlab-workspace-setup",
        "scripts/guest/agentlab-workspace-setup.service",
        "scripts/guest/work.mount",
        "to-do.json"
      ]
    },
    {
      "id": "T026",
      "title": "Implement workspace rebind workflow",
      "priority": 2,
      "status": "done",
      "details": "Create new sandbox, attach workspace, and safely detach/destroy old sandbox as requested.",
      "depends_on": [
        "T024",
        "T025",
        "T012"
      ],
      "updated_at": "2026-01-30T03:14:51Z",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/workspace_rebind.go",
        "to-do.json"
      ]
    },
    {
      "id": "T027",
      "title": "Implement embedded artifact upload service in agentlabd",
      "priority": 1,
      "status": "done",
      "details": "Expose 10.77.0.1:8846 upload endpoint with scoped tokens, size limits, path sanitization, and DB metadata.",
      "depends_on": [
        "T010",
        "T017"
      ],
      "updated_at": "2026-01-30T01:24:43Z",
      "files": [
        "docs/secrets.md",
        "internal/config/config.go",
        "internal/daemon/api_types.go",
        "internal/daemon/artifact_api.go",
        "internal/daemon/artifact_api_test.go",
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/daemon/daemon.go",
        "internal/db/artifact_tokens.go",
        "internal/db/artifacts.go",
        "internal/db/migrations.go",
        "to-do.json"
      ]
    },
    {
      "id": "T028",
      "title": "Implement CLI artifact listing and download",
      "priority": 2,
      "status": "done",
      "details": "Provide job artifacts list and download commands, including latest bundle shortcut.",
      "depends_on": [
        "T027",
        "T022"
      ],
      "updated_at": "2026-01-30T03:28:15Z",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/daemon.go",
        "to-do.json"
      ]
    },
    {
      "id": "T029",
      "title": "Implement artifact retention and garbage collection",
      "priority": 2,
      "status": "done",
      "details": "Apply per-profile TTLs, delete expired artifacts, and report deletions safely.",
      "depends_on": [
        "T027",
        "T012"
      ],
      "updated_at": "2026-01-30T03:37:18Z",
      "files": [
        "internal/daemon/artifact_api_test.go",
        "internal/daemon/artifact_gc.go",
        "internal/daemon/artifact_gc_test.go",
        "internal/daemon/daemon.go",
        "internal/db/artifacts.go",
        "to-do.json"
      ]
    },
    {
      "id": "T030",
      "title": "Ship agentlab Skills file for Claude Code CLI",
      "priority": 1,
      "status": "done",
      "details": "Create skills/agentlab/SKILL.md mapping high-level commands to agentlab CLI with guardrails.",
      "depends_on": [
        "T022"
      ],
      "updated_at": "2026-01-30T01:30:10Z",
      "files": [
        "skills/agentlab/SKILL.md",
        "to-do.json"
      ]
    },
    {
      "id": "T031",
      "title": "Package Skills with Claude Code configuration",
      "priority": 2,
      "status": "done",
      "details": "Document placement and ensure install_host or template build makes Skills discoverable.",
      "depends_on": [
        "T030",
        "T019"
      ],
      "updated_at": "2026-01-30T03:44:05Z",
      "files": [
        "AGENTLAB_DEV_SPECIFICATION.md",
        "scripts/README.md",
        "scripts/install_host.sh",
        "skills/agentlab/SKILL.md",
        "to-do.json"
      ]
    },
    {
      "id": "T032",
      "title": "Enforce no-host-mount policy in provisioning",
      "priority": 1,
      "status": "done",
      "details": "Add guardrails to refuse profiles requesting host bind mounts and document rationale.",
      "depends_on": [
        "T007"
      ],
      "updated_at": "2026-01-30T01:37:45Z",
      "files": [
        "internal/daemon/profile_validation.go",
        "internal/daemon/api.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/profile_validation_test.go",
        "internal/daemon/job_orchestrator_test.go",
        "PROXMOX_SPECS.md"
      ]
    },
    {
      "id": "T033",
      "title": "Implement secret redaction and log safety",
      "priority": 1,
      "status": "done",
      "details": "Scrub bootstrap tokens and sensitive env keys from logs with automated tests.",
      "depends_on": [
        "T015",
        "T017",
        "T020"
      ],
      "updated_at": "2026-01-30T01:50:34Z",
      "files": [
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/redaction.go",
        "internal/daemon/redaction_test.go",
        "scripts/guest/agent-runner",
        "to-do.json"
      ]
    },
    {
      "id": "T034",
      "title": "Harden agentlabd systemd service",
      "priority": 2,
      "status": "done",
      "details": "Apply ProtectSystem, PrivateTmp, NoNewPrivileges, and capability restrictions while keeping provisioning functional.",
      "depends_on": [
        "T002"
      ],
      "updated_at": "2026-01-30T03:46:56Z",
      "files": [
        "scripts/systemd/agentlabd.service",
        "to-do.json"
      ]
    },
    {
      "id": "T035",
      "title": "Evaluate optional inner sandboxing for agent process (bubblewrap)",
      "priority": 3,
      "status": "done",
      "details": "Prototype bubblewrap execution and document tradeoffs behind a profile flag.",
      "depends_on": [
        "T020"
      ],
      "updated_at": "2026-01-30T04:25:49Z",
      "files": [
        "PROXMOX_SPECS.md",
        "docs/runbook.md",
        "internal/daemon/api_types.go",
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/daemon/profile_inner_sandbox.go",
        "internal/daemon/profile_validation.go",
        "scripts/create_template.sh",
        "scripts/guest/agent-runner",
        "scripts/guest/agent-runner.env",
        "scripts/profiles/defaults.yaml",
        "to-do.json"
      ]
    },
    {
      "id": "T036",
      "title": "Implement event stream storage and per-job log surfaces",
      "priority": 2,
      "status": "done",
      "details": "Persist events in DB and surface recent events in job show responses.",
      "depends_on": [
        "T011",
        "T020"
      ],
      "updated_at": "2026-01-30T03:54:25Z",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/db/events.go",
        "to-do.json"
      ]
    },
    {
      "id": "T037",
      "title": "Write operator runbook documentation",
      "priority": 2,
      "status": "done",
      "details": "Cover template build, secrets rotation, debugging stuck sandboxes, daemon recovery, and Tailscale routing.",
      "depends_on": [
        "T003",
        "T005",
        "T018",
        "T002"
      ],
      "updated_at": "2026-01-30T03:57:59Z",
      "files": [
        "docs/runbook.md",
        "to-do.json"
      ]
    },
    {
      "id": "T038",
      "title": "Add optional Prometheus metrics endpoint",
      "priority": 3,
      "status": "done",
      "details": "Expose /metrics behind localhost-only flag with sandbox/job counters and timing distributions.",
      "depends_on": [
        "T010"
      ],
      "updated_at": "2026-01-30T04:35:55Z",
      "files": [
        "docs/runbook.md",
        "go.mod",
        "go.sum",
        "internal/config/config.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/metrics.go",
        "internal/daemon/sandbox_manager.go",
        "to-do.json"
      ]
    },
    {
      "id": "T039",
      "title": "Create end-to-end golden path integration test",
      "priority": 1,
      "status": "done",
      "details": "Automate sandbox create → run trivial repo task → upload artifact → teardown validation.",
      "depends_on": [
        "T002",
        "T004",
        "T014",
        "T020"
      ],
      "updated_at": "2026-01-30T01:59:57Z",
      "files": [
        "scripts/README.md",
        "scripts/tests/golden_path.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T040",
      "title": "Add network isolation regression tests",
      "priority": 2,
      "status": "done",
      "details": "Verify LAN/tailnet blocks and Internet egress from sandbox with repeatable checks.",
      "depends_on": [
        "T004",
        "T005"
      ],
      "updated_at": "2026-01-30T04:04:23Z",
      "files": [
        "scripts/README.md",
        "scripts/tests/network_isolation.sh",
        "to-do.json"
      ]
    },
    {
      "id": "T041",
      "title": "Ship default profile YAMLs for yolo-ephemeral, yolo-workspace, and interactive-dev",
      "priority": 2,
      "status": "done",
      "details": "Provide baseline resource/network/secrets bundle configs in scripts/profiles/defaults.yaml compatible with agentlabd loader.",
      "depends_on": [
        "T010"
      ],
      "updated_at": "2026-01-30T04:09:50Z",
      "files": [
        "scripts/README.md",
        "scripts/profiles/defaults.yaml",
        "to-do.json"
      ]
    },
    {
      "id": "T042",
      "title": "Require explicit agent subnet/controller URLs when bootstrap/artifact listeners bind to wildcard",
      "priority": 1,
      "status": "done",
      "details": "bootstrap_listen/artifact_listen allow 0.0.0.0 or :port today, which yields invalid controller/artifact URLs and disables subnet restriction. Add validation or explicit config (agent_subnet/controller_url/artifact_upload_url), enforce remoteAllowed using the configured subnet, and cover with tests.",
      "updated_at": "2026-01-30T04:59:30Z",
      "files": [
        "internal/config/config.go",
        "internal/config/config_test.go",
        "internal/daemon/artifact_api.go",
        "internal/daemon/artifact_api_test.go",
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/daemon/daemon.go",
        "internal/daemon/testutil_test.go",
        "to-do.json"
      ]
    },
    {
      "id": "T043",
      "title": "Provision real VMs for sandbox new flow",
      "priority": 2,
      "status": "done",
      "details": "sandbox new currently creates only a DB record. Add a provisioning pipeline for non-job sandboxes (clone template, configure cloud-init/snippet, apply profile resources, start VM, IP discovery, state transitions) and align API/CLI/docs. Ensure destroy handles missing VMs gracefully.",
      "updated_at": "2026-01-30T05:11:06Z",
      "files": [
        "cmd/agentlab/commands.go",
        "docs/api.md",
        "internal/daemon/api.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "internal/daemon/profile_resources.go",
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/sandbox_manager_test.go",
        "internal/daemon/workspace_rebind.go",
        "internal/proxmox/errors.go",
        "internal/proxmox/shell_backend.go",
        "to-do.json"
      ]
    },
    {
      "id": "T044",
      "title": "Run agentlab-agent inside repo directory in agent-runner",
      "priority": 1,
      "status": "done",
      "details": "When AGENT_COMMAND defaults to agentlab-agent, agent-runner does not cd into the repo, so agents start outside the checkout. Update scripts/guest/agent-runner to run agentlab-agent from $REPO_DIR and add a regression check (unit/integration) if feasible.",
      "files": [
        "scripts/README.md",
        "scripts/guest/agent-runner",
        "scripts/tests/agent_runner_repo_dir.sh",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T05:35:33Z"
    },
    {
      "id": "T045",
      "title": "Avoid consuming bootstrap tokens before response is ready",
      "priority": 1,
      "status": "done",
      "details": "BootstrapAPI consumes the one-time token before issuing artifact tokens and building the response; any subsequent error burns the token and prevents retries. Reorder/transactionalize token consumption or add a validate-then-consume flow, and add a test for retry safety.",
      "files": [
        "internal/daemon/bootstrap_api.go",
        "internal/daemon/bootstrap_api_test.go",
        "internal/db/bootstrap_tokens.go",
        "internal/db/bootstrap_tokens_test.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T05:41:20Z"
    },
    {
      "id": "T046",
      "title": "Apply profile keepalive/TTL defaults when creating jobs/sandboxes",
      "priority": 2,
      "status": "done",
      "details": "Profiles define behavior.keepalive_default and behavior.ttl_minutes_default but the API currently ignores them when TTL/keepalive are omitted. Parse these defaults and apply them for job create, sandbox new, and workspace rebind (when ttl/keepalive not explicitly set). Add tests.",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "internal/daemon/api.go",
        "internal/daemon/api_types.go",
        "internal/daemon/behavior_defaults_test.go",
        "internal/daemon/profile_behavior.go",
        "internal/daemon/workspace_rebind.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T05:58:01Z"
    },
    {
      "id": "T047",
      "title": "Restrict runner report endpoint to agent subnet or add authentication",
      "priority": 1,
      "status": "done",
      "details": "Runner reports are accepted from any remote address on the bootstrap listener. Enforce agent-subnet checks (like bootstrap/artifact) and/or require a shared token from the bootstrap payload; add coverage for rejection of non-agent sources.",
      "files": [
        "internal/daemon/runner_api.go",
        "internal/daemon/daemon.go",
        "internal/daemon/runner_api_test.go",
        "internal/daemon/bootstrap_api.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T06:11:53Z"
    },
    {
      "id": "T048",
      "title": "Move guest secrets directory under /run/agentlab to avoid clobbering /run/secrets",
      "priority": 2,
      "status": "done",
      "details": "Use an agentlab-specific secrets path (for example /run/agentlab/secrets) and update agent-runner, cleanup script, and systemd unit/runtime directories accordingly.",
      "files": [
        "AGENTLAB_DEV_SPECIFICATION.md",
        "PROXMOX_SPECS.md",
        "docs/runbook.md",
        "scripts/guest/agent-runner",
        "scripts/guest/agent-runner.service",
        "scripts/guest/agent-secrets-cleanup",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T06:16:41Z"
    },
    {
      "id": "T049",
      "title": "Add timeouts for CLI HTTP calls and provisioning steps",
      "priority": 3,
      "status": "done",
      "details": "The CLI client and job provisioning path can hang indefinitely when agentlabd or Proxmox commands stall. Add configurable timeouts (HTTP client, job orchestration/provisioning) and propagate context deadlines.",
      "files": [
        "cmd/agentlab/api.go",
        "cmd/agentlab/commands.go",
        "cmd/agentlab/main.go",
        "cmd/agentlab/ssh.go",
        "internal/config/config.go",
        "internal/daemon/daemon.go",
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/workspace_rebind.go",
        "internal/proxmox/shell_backend.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T06:34:35Z"
    },
    {
      "id": "T050",
      "title": "Expand README with overview, prerequisites, and quickstart",
      "priority": 4,
      "status": "done",
      "details": "README currently contains only the title. Add a concise overview, setup prerequisites, and links to runbook/secrets/API docs.",
      "files": [
        "README.md",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T06:36:25Z"
    },
    {
      "id": "T051",
      "title": "Detach workspaces during lease GC cleanup",
      "priority": 2,
      "status": "done",
      "details": "Sandbox lease GC (SandboxManager.expireSandbox) destroys VMs without detaching workspace volumes or clearing workspace_id, leaving workspaces marked attached after TTL expiry. Detach via WorkspaceManager (tolerate missing VMs) and add coverage.",
      "files": [
        "internal/daemon/sandbox_manager.go",
        "internal/daemon/sandbox_manager_test.go",
        "internal/daemon/workspace_manager.go",
        "internal/proxmox/shell_backend.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T06:53:42Z"
    },
    {
      "id": "T052",
      "title": "Ensure job failure cleanup succeeds after provisioning timeouts",
      "priority": 2,
      "status": "done",
      "details": "JobOrchestrator.Run/ProvisionSandbox uses a timeout context; when it expires, failJob and deferred cleanup run with a canceled context so job status updates and sandbox/snippet cleanup can be skipped. Use a fresh background context (with a short timeout) for failure updates/cleanup and add tests for timeout paths.",
      "files": [
        "internal/daemon/job_orchestrator.go",
        "internal/daemon/job_orchestrator_test.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T07:07:19Z"
    },
    {
      "id": "T053",
      "title": "Propagate agent subnet to Proxmox IP discovery",
      "priority": 2,
      "status": "done",
      "details": "ShellBackend GuestIP selection ignores the configured agent subnet when multiple NICs are present. Wire agent_subnet (or derived subnet) into ShellBackend.AgentCIDR so IP discovery prefers vmbr1 addresses; add regression coverage for multi-IP selection.",
      "files": [
        "internal/daemon/daemon.go",
        "internal/daemon/daemon_test.go"
      ],
      "updated_at": "2026-01-30T07:25:19Z"
    },
    {
      "id": "T054",
      "title": "Use failure-timeout context for workspace rebind cleanup",
      "priority": 2,
      "status": "done",
      "details": "RebindWorkspace cleanup currently runs with the provision timeout context, so detach/reattach/destroy can be skipped after a timeout. Use a fresh background context with a short timeout for cleanup steps (matching job/provision cleanup) and add a timeout-path test.",
      "files": [
        "internal/daemon/workspace_rebind.go",
        "internal/daemon/job_orchestrator_test.go",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T07:32:01Z"
    },
    {
      "id": "T055",
      "title": "Add curl timeouts for agent-runner bootstrap/report/upload",
      "priority": 3,
      "status": "done",
      "details": "agent-runner uses curl without connect/max timeouts for bootstrap fetch, status reports, and artifact uploads, which can hang indefinitely on network stalls. Add sane defaults (configurable via env) to prevent job hangs.",
      "files": [
        "scripts/guest/agent-runner",
        "scripts/guest/agent-runner.env"
      ],
      "updated_at": "2026-01-30T07:36:15Z"
    },
    {
      "id": "T056",
      "title": "Avoid agent-runner restart loops on jobless sandboxes",
      "priority": 2,
      "status": "done",
      "details": "agent-runner currently treats a 404 from /v1/bootstrap/fetch as a hard failure, which causes systemd restart loops for sandboxes created without jobs (sandbox new). Handle the no-job case explicitly (e.g., treat 404 as a clean exit, or gate runner start when no job is associated) and add a regression test or documented behavior.",
      "files": [
        "scripts/guest/agent-runner",
        "scripts/tests/agent_runner_no_job.sh",
        "to-do.json"
      ],
      "updated_at": "2026-01-30T08:01:33Z"
    },
    {
      "id": "T057",
      "title": "Ensure create_template.sh creates cache dir when --image-file is used",
      "priority": 3,
      "status": "done",
      "details": "create_template.sh only creates CACHE_DIR when downloading the image; if --image-file is supplied and CACHE_DIR is missing, the WORK_IMAGE copy fails. Ensure the cache/work directory exists regardless of image source (and consider a small sanity check/test).",
      "files": [
        "scripts/create_template.sh"
      ],
      "updated_at": "2026-01-30T08:16:19Z"
    },
    {
      "id": "T058",
      "title": "Remove on-disk artifact if metadata insert fails",
      "priority": 3,
      "status": "done",
      "details": "Artifact uploads currently write the file before inserting the DB record; if CreateArtifact fails, the file is left behind and will never be GC’d. Delete the staged/renamed file on DB errors and add a regression test that forces a DB insert failure.",
      "tags": [
        "bug",
        "artifacts"
      ],
      "files": [
        "internal/daemon/artifact_api.go",
        "internal/daemon/artifact_api_test.go"
      ],
      "updated_at": "2026-01-30T08:32:29Z"
    }
  ]
}
